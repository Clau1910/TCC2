{% extends 'base.html' %}

{% block head %}
  {{ super() }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='calendario.css') }}">
{% endblock %}

{% block content %}
<div class="cabecalho-institucional">
    Educação Profissional Paulista
</div>

<div class="cabecalho-funcional">
    <h2>Minhas Disciplinas / Calendário</h2>
    <button class="btn btn-primary btn-notificacao" onclick="verificarNotificacoes()">
        <i class="bi bi-bell"></i>
    </button>
</div>

<div class="calendario-container">
    <!-- Barra Lateral -->
    <div class="barra-lateral">
        <h4>Status das Tarefas</h4>
        <div class="filtros-container">
            <div class="filtro-grupo">
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #ffc107"></div>
                    <span class="filtro-texto">Pendentes</span>
                </div>
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #dc3545"></div>
                    <span class="filtro-texto">Atrasadas</span>
                </div>
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #28a745"></div>
                    <span class="filtro-texto">Concluídas</span>
                </div>
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #17a2b8"></div>
                    <span class="filtro-texto">Em Andamento</span>
                </div>
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #fd7e14"></div>
                    <span class="filtro-texto">Próximas</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Área Principal do Calendário -->
    <div class="area-calendario">
        <div class="calendar-header">
            <button class="btn btn-outline-primary" onclick="mudarMes(-1)">
                <i class="bi bi-chevron-left"></i>
            </button>
            <h3 id="mes-atual" class="text-center"></h3>
            <button class="btn btn-outline-primary" onclick="mudarMes(1)">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        
        <div class="calendar">
            <div class="calendar-weekdays">
                <div>Dom</div>
                <div>Seg</div>
                <div>Ter</div>
                <div>Qua</div>
                <div>Qui</div>
                <div>Sex</div>
                <div>Sáb</div>
            </div>
            <div class="calendar-days" id="calendar-days"></div>
        </div>
    </div>
</div>

<script>
let dataAtual = new Date();
let tarefas = [];

// Carregar tarefas do servidor
function carregarTarefas() {
    axios.get('/tarefas_events')
        .then(function(response) {
            tarefas = response.data;
            renderizarCalendario();
            verificarNotificacoes();
        })
        .catch(function(error) {
            console.error('Erro ao carregar tarefas:', error);
        });
}

// Renderizar calendário
function renderizarCalendario() {
    const mesAtualElement = document.getElementById('mes-atual');
    const calendarDays = document.getElementById('calendar-days');
    
    const mes = dataAtual.getMonth();
    const ano = dataAtual.getFullYear();
    
    // Nome do mês em português
    const meses = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    mesAtualElement.textContent = `${meses[mes]} ${ano}`;
    
    // Primeiro dia do mês
    const primeiroDia = new Date(ano, mes, 1);
    const ultimoDia = new Date(ano, mes + 1, 0);
    
    // Dias do mês anterior para preencher a primeira semana
    const diasMesAnterior = primeiroDia.getDay();
    
    // Limpar calendário
    calendarDays.innerHTML = '';
    
    // Dias do mês anterior
    const ultimoDiaMesAnterior = new Date(ano, mes, 0).getDate();
    for (let i = diasMesAnterior - 1; i >= 0; i--) {
        const dia = ultimoDiaMesAnterior - i;
        const dayElement = criarDiaElemento(dia, 'outro-mes');
        calendarDays.appendChild(dayElement);
    }
    
    // Dias do mês atual
    for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const data = new Date(ano, mes, dia);
        const tarefasDia = tarefas.filter(t => {
            const dataTarefa = new Date(t.start);
            return dataTarefa.getDate() === dia && 
                   dataTarefa.getMonth() === mes && 
                   dataTarefa.getFullYear() === ano;
        });
        
        const dayElement = criarDiaElemento(dia, '', tarefasDia, data);
        calendarDays.appendChild(dayElement);
    }
    
    // Dias do próximo mês para completar a última semana
    const diasRestantes = 42 - (diasMesAnterior + ultimoDia.getDate());
    for (let dia = 1; dia <= diasRestantes; dia++) {
        const dayElement = criarDiaElemento(dia, 'outro-mes');
        calendarDays.appendChild(dayElement);
    }
}

function criarDiaElemento(dia, classe, tarefasDia = [], data = null) {
    const dayElement = document.createElement('div');
    dayElement.className = `calendar-day ${classe}`;
    
    if (data && data.toDateString() === new Date().toDateString()) {
        dayElement.classList.add('today');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = dia;
    dayElement.appendChild(dayNumber);
    
    if (tarefasDia.length > 0) {
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'day-events';
        
        tarefasDia.forEach(tarefa => {
            const eventElement = document.createElement('div');
            eventElement.className = `calendar-event ${tarefa.className}`;
            eventElement.textContent = tarefa.title;
            eventElement.title = tarefa.description;
            eventElement.onclick = () => abrirModalTarefa(tarefa);
            eventsContainer.appendChild(eventElement);
        });
        
        dayElement.appendChild(eventsContainer);
    }
    
    return dayElement;
}

function mudarMes(delta) {
    dataAtual.setMonth(dataAtual.getMonth() + delta);
    renderizarCalendario();
}

function abrirModalTarefa(tarefa) {
    alert(`Tarefa: ${tarefa.title}\nData: ${new Date(tarefa.start).toLocaleDateString('pt-BR')}\nDescrição: ${tarefa.description}`);
}

// Sistema de notificações
function verificarNotificacoes() {
    const notificacoes = [];
    const hoje = new Date();
    
    tarefas.forEach(tarefa => {
        const prazo = new Date(tarefa.start);
        const diasRestantes = Math.ceil((prazo - hoje) / (1000 * 60 * 60 * 24));
        
        if (diasRestantes <= 3 && diasRestantes >= 0) {
            notificacoes.push({
                titulo: tarefa.title,
                dias: diasRestantes,
                tipo: 'proxima'
            });
        } else if (diasRestantes < 0) {
            notificacoes.push({
                titulo: tarefa.title,
                dias: Math.abs(diasRestantes),
                tipo: 'atrasada'
            });
        }
    });
    
    if (notificacoes.length > 0) {
        mostrarNotificacoes(notificacoes);
    }
}

function mostrarNotificacoes(notificacoes) {
    const notificacaoElement = document.createElement('div');
    notificacaoElement.className = 'notificacao-container';
    notificacaoElement.innerHTML = `
        <div class="notificacao-header">
            <i class="bi bi-bell-fill"></i>
            <span>Notificações</span>
            <button onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
        <div class="notificacao-content">
            ${notificacoes.map(not => `
                <div class="notificacao-item notificacao-${not.tipo}">
                    <strong>${not.titulo}</strong>
                    <span>${not.tipo === 'proxima' ? `Entrega em ${not.dias} dias` : `Atrasada há ${not.dias} dias`}</span>
                </div>
            `).join('')}
        </div>
    `;
    
    document.body.appendChild(notificacaoElement);
}

// Inicializar calendário
document.addEventListener('DOMContentLoaded', function() {
    carregarTarefas();
});
</script>
{% endblock %}
