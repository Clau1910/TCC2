{% extends 'base.html' %}

{% block head %}
  {{ super() }}
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='calendario.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="cabecalho-institucional">
    Educação Profissional Paulista
</div>

<div class="cabecalho-funcional">
    <h2>Calendário</h2>
</div>

<div class="calendario-container">
    <!-- Barra Lateral -->
    <div class="barra-lateral">
        <h4>Filtros</h4>
        <div class="filtros-container">
            <div class="filtro-grupo">
                <h4>Status das Tarefas</h4>
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #ffc107"></div>
                    <span class="filtro-texto">Pendentes</span>
                </div>
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #dc3545"></div>
                    <span class="filtro-texto">Atrasadas</span>
                </div>
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #28a745"></div>
                    <span class="filtro-texto">Concluídas</span>
                </div>
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #17a2b8"></div>
                    <span class="filtro-texto">Em Andamento</span>
                </div>
                <div class="filtro-item">
                    <div class="filtro-marcador" style="background-color: #fd7e14"></div>
                    <span class="filtro-texto">Próximas</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Área Principal do Calendário -->
    <div class="area-calendario">
        <div id='calendar' style="min-height: 600px;"></div>
    </div>
</div>

<!-- Modal para detalhes da tarefa -->
<div class="modal fade" id="tarefaModal" tabindex="-1" role="dialog" aria-labelledby="tarefaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <!-- Conteúdo do modal -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    if (calendarEl) {
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridYear', // Visualização anual
            locale: 'pt-br',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridYear,dayGridMonth,timeGridWeek,timeGridDay'
            },
            views: {
                dayGridYear: {
                    type: 'dayGrid',
                    duration: { years: 1 },
                    buttonText: 'Ano'
                }
            },
            events: function(fetchInfo, successCallback, failureCallback) {
                // Carregar eventos dinamicamente do backend
                axios.get('/tarefas_events')
                    .then(function(response) {
                        successCallback(response.data);
                    })
                    .catch(function(error) {
                        console.error('Erro ao carregar eventos:', error);
                        failureCallback(error);
                    });
            },
            eventClick: function(info) {
                // Abrir modal com detalhes da tarefa
                abrirModalTarefa(info.event);
            },
            loading: function(isLoading) {
                // Mostrar/ocultar indicador de carregamento
                var loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = isLoading ? 'block' : 'none';
                }
            }
        });
        calendar.render();
        
        // Carregar eventos após a renderização
        calendar.refetchEvents();
    }
});

function abrirModalTarefa(evento) {
    // Implementar modal de detalhes da tarefa
    console.log('Tarefa clicada:', evento);
    // Aqui você pode implementar um modal com os detalhes completos da tarefa
    alert('Tarefa: ' + evento.title + '\nData: ' + evento.start.toLocaleDateString('pt-BR'));
}

// Sistema de notificações
function verificarNotificacoes() {
    axios.get('/tarefas_events')
        .then(function(response) {
            var tarefas = response.data;
            var notificacoes = [];
            
            tarefas.forEach(function(tarefa) {
                var hoje = new Date();
                var prazo = new Date(tarefa.start);
                var diasRestantes = Math.ceil((prazo - hoje) / (1000 * 60 * 60 * 24));
                
                if (diasRestantes <= 3 && diasRestantes >= 0) {
                    notificacoes.push({
                        titulo: tarefa.title,
                        dias: diasRestantes,
                        tipo: 'proxima'
                    });
                } else if (diasRestantes < 0) {
                    notificacoes.push({
                        titulo: tarefa.title,
                        dias: Math.abs(diasRestantes),
                        tipo: 'atrasada'
                    });
                }
            });
            
            if (notificacoes.length > 0) {
                mostrarNotificacoes(notificacoes);
            }
        })
        .catch(function(error) {
            console.error('Erro ao verificar notificações:', error);
        });
}

function mostrarNotificacoes(notificacoes) {
    // Criar elemento de notificação
    var notificacaoElement = document.createElement('div');
    notificacaoElement.className = 'notificacao-container';
    notificacaoElement.innerHTML = `
        <div class="notificacao-header">
            <i class="bi bi-bell-fill"></i>
            <span>Notificações</span>
            <button onclick="fecharNotificacoes()">&times;</button>
        </div>
        <div class="notificacao-content">
            ${notificacoes.map(not => `
                <div class="notificacao-item notificacao-${not.tipo}">
                    <strong>${not.titulo}</strong>
                    <span>${not.tipo === 'proxima' ? `Entrega em ${not.dias} dias` : `Atrasada há ${not.dias} dias`}</span>
                </div>
            `).join('')}
        </div>
    `;
    
    document.body.appendChild(notificacaoElement);
    
    // Adicionar estilo para a notificação
    var style = document.createElement('style');
    style.textContent = `
        .notificacao-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            max-width: 300px;
        }
        .notificacao-header {
            background: #1a73e8;
            color: white;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 8px 8px 0 0;
        }
        .notificacao-content {
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .notificacao-item {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .notificacao-proxima {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .notificacao-atrasada {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
    `;
    document.head.appendChild(style);
}

function fecharNotificacoes() {
    var notificacao = document.querySelector('.notificacao-container');
    if (notificacao) {
        notificacao.remove();
    }
}

// Verificar notificações ao carregar a página
setTimeout(verificarNotificacoes, 2000);

// Adicionar botão de notificação no cabeçalho
function adicionarBotaoNotificacao() {
    var cabecalho = document.querySelector('.cabecalho-funcional');
    if (cabecalho) {
        var botaoNotificacao = document.createElement('button');
        botaoNotificacao.className = 'btn-notificacao';
        botaoNotificacao.innerHTML = '<i class="bi bi-bell"></i>';
        botaoNotificacao.onclick = verificarNotificacoes;
        botaoNotificacao.style.marginLeft = 'auto';
        botaoNotificacao.style.marginRight = '20px';
        botaoNotificacao.style.background = '#1a73e8';
        botaoNotificacao.style.color = 'white';
        botaoNotificacao.style.border = 'none';
        botaoNotificacao.style.borderRadius = '50%';
        botaoNotificacao.style.width = '40px';
        botaoNotificacao.style.height = '40px';
        botaoNotificacao.style.cursor = 'pointer';
        
        cabecalho.appendChild(botaoNotificacao);
    }
}

// Adicionar botão quando o DOM estiver carregado
adicionarBotaoNotificacao();
</script>
{% endblock %}
